<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scattergories - Teacher Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #F7931E;
            --accent: #FDC500;
            --dark: #1A1A2E;
            --darker: #0F0F1E;
            --light: #EAEAEA;
            --success: #00D9A5;
            --danger: #FF4757;
            --warning: #FFA502;
            --purple: #A459D1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(164, 89, 209, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-family: 'Righteous', cursive;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
        }

        .help-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .help-btn:hover {
            background: var(--accent);
            color: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(253, 197, 0, 0.3);
        }

        .help-panel {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            animation: slideDown 0.3s ease;
        }

        .help-panel.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .help-panel h2 {
            color: var(--accent);
            margin-bottom: 20px;
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
        }

        .help-panel ol {
            margin-left: 20px;
        }

        .help-panel li {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .help-panel strong {
            color: var(--primary);
        }

        .setup-screen, .game-screen, .adjudication-screen, .results-screen {
            display: none;
        }

        .setup-screen.active, .game-screen.active, .adjudication-screen.active, .results-screen.active {
            display: block;
        }

        .setup-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            margin: 50px auto;
            text-align: center;
        }

        .game-code-display {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            font-size: 3rem;
            font-family: 'Righteous', cursive;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            letter-spacing: 8px;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
        }

        .game-display {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .timer-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
        }

        .timer {
            font-family: 'Righteous', cursive;
            font-size: 5rem;
            color: var(--accent);
            margin: 20px 0;
            text-shadow: 0 0 30px rgba(253, 197, 0, 0.5);
        }

        .timer.warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .categories-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .letter-display {
            font-family: 'Righteous', cursive;
            font-size: 4rem;
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
        }

        .categories-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .category-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .category-number {
            color: var(--accent);
            font-weight: 700;
            margin-right: 8px;
        }

        .submissions-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .submissions-card h2 {
            color: var(--accent);
            font-family: 'Righteous', cursive;
            margin-bottom: 20px;
        }

        .submission-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .student-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .student-name {
            font-family: 'Righteous', cursive;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .student-score {
            font-family: 'Righteous', cursive;
            font-size: 2rem;
            color: var(--accent);
        }

        .answer-row {
            display: grid;
            grid-template-columns: 60px 1fr 100px;
            gap: 15px;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .answer-row.unique {
            background: rgba(0, 217, 165, 0.1);
            border-left: 4px solid var(--success);
        }

        .answer-row.duplicate {
            background: rgba(255, 71, 87, 0.1);
            border-left: 4px solid var(--danger);
        }

        .answer-row.needs-review {
            background: rgba(255, 165, 2, 0.1);
            border-left: 4px solid var(--warning);
        }

        .answer-category {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .answer-text {
            font-size: 1.1rem;
        }

        .answer-status {
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .unique .answer-status { color: var(--success); }
        .duplicate .answer-status { color: var(--danger); }
        .needs-review .answer-status { color: var(--warning); }

        .adjudication-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-approve, .btn-reject {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-approve {
            background: var(--success);
            color: white;
        }

        .btn-approve:hover {
            background: #00b389;
            transform: translateY(-2px);
        }

        .btn-reject {
            background: var(--danger);
            color: white;
        }

        .btn-reject:hover {
            background: #e63946;
            transform: translateY(-2px);
        }

        .scoreboard {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .scoreboard h2 {
            color: var(--accent);
            font-family: 'Righteous', cursive;
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .scoreboard-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.08);
            padding: 20px 25px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .score-item:first-child {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .score-rank {
            font-family: 'Righteous', cursive;
            font-size: 2rem;
            color: var(--accent);
            min-width: 60px;
        }

        .score-item:first-child .score-rank {
            color: var(--accent);
            font-size: 2.5rem;
        }

        .score-name {
            flex: 1;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .score-item:first-child .score-name {
            font-size: 1.6rem;
            color: white;
        }

        .score-points {
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
            color: var(--success);
        }

        .score-item:first-child .score-points {
            font-size: 2.2rem;
            color: var(--accent);
        }

        .winner-announcement {
            text-align: center;
            margin: 40px 0;
            animation: fadeInScale 0.5s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .winner-announcement h2 {
            font-family: 'Righteous', cursive;
            font-size: 3rem;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .winner-name {
            font-family: 'Righteous', cursive;
            font-size: 4rem;
            color: var(--primary);
            text-shadow: 0 0 40px rgba(255, 107, 53, 0.6);
            margin: 20px 0;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .student-url-display {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .student-url-display p {
            margin-bottom: 10px;
            color: var(--light);
        }

        .student-url-display code {
            background: var(--darker);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            font-size: 1.1rem;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .game-display {
                grid-template-columns: 1fr;
            }

            .categories-list {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }

            .timer {
                font-size: 3.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ SCATTERGORIES Teacher Control</h1>
            <button class="help-btn" onclick="toggleHelp()">‚ùì How to Use</button>
        </header>

        <div id="demoModeBanner" style="display: none; background: rgba(253, 197, 0, 0.2); border: 2px solid var(--accent); color: var(--accent); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-weight: 600;">
            üéÆ DEMO MODE - Running locally without AWS backend. Perfect for testing!
        </div>

        <div class="help-panel" id="helpPanel">
            <h2>üìö Quick Start Guide</h2>
            <ol>
                <li><strong>Start a New Game:</strong> Click "New Game" to generate a unique game code. Share this code with your students.</li>
                <li><strong>Student Access:</strong> Students go to the student page and enter the game code along with their name.</li>
                <li><strong>Display Categories:</strong> The letter and 12 categories will appear on this screen - display it on your class TV.</li>
                <li><strong>5-Minute Timer:</strong> The timer starts automatically. Students have 5 minutes to submit their answers.</li>
                <li><strong>Monitor Submissions:</strong> Watch as students submit their answers in real-time.</li>
                <li><strong>Adjudicate Answers:</strong> After time's up, review all answers:
                    <ul>
                        <li><strong style="color: #00D9A5;">Green</strong> = Unique answer (1 point)</li>
                        <li><strong style="color: #FF4757;">Red</strong> = Duplicate answer (0 points)</li>
                        <li><strong style="color: #FFA502;">Orange</strong> = Needs your review - approve or reject</li>
                    </ul>
                </li>
                <li><strong>Finalise Results:</strong> Once you've reviewed orange answers, click "Finalise Results" to see the winner.</li>
                <li><strong>New Round:</strong> Click "New Round" to start fresh with a new letter and categories.</li>
            </ol>
        </div>

        <!-- Setup Screen -->
        <div class="setup-screen active" id="setupScreen">
            <div class="setup-card">
                <h2 style="font-family: 'Righteous', cursive; font-size: 2rem; margin-bottom: 20px;">Ready to Play?</h2>
                <p style="margin-bottom: 30px; font-size: 1.1rem;">Start a new game and share the code with your students!</p>
                <button class="btn" onclick="startNewGame()">üéÆ New Game</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="setup-card">
                <h2 style="font-family: 'Righteous', cursive; font-size: 2rem; margin-bottom: 20px;">Game Code</h2>
                <div class="game-code-display" id="gameCodeDisplay">----</div>
                <div class="student-url-display">
                    <p><strong>Students should go to:</strong></p>
                    <code id="studentUrl">student.html</code>
                </div>
                <p style="margin: 20px 0;">Share this code with your students!</p>
                <button class="btn" onclick="startTimer()">‚ñ∂Ô∏è Start Timer</button>
            </div>

            <div class="game-display">
                <div class="timer-card">
                    <h3 style="color: var(--accent); margin-bottom: 10px;">Time Remaining</h3>
                    <div class="timer" id="timer">5:00</div>
                    <button class="btn" onclick="endGame()" style="margin-top: 20px;">‚èπÔ∏è End Round</button>
                </div>

                <div class="categories-card">
                    <div class="letter-display" id="letterDisplay">?</div>
                    <div class="categories-list" id="categoriesList"></div>
                </div>
            </div>

            <div class="submissions-card">
                <h2>üìù Student Submissions (<span id="submissionCount">0</span>)</h2>
                <div id="submissionsList"></div>
            </div>
        </div>

        <!-- Adjudication Screen -->
        <div class="adjudication-screen" id="adjudicationScreen">
            <div class="scoreboard">
                <h2>üèÜ Current Scoreboard</h2>
                <div class="scoreboard-list" id="currentScoreboard"></div>
            </div>

            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn" onclick="finaliseResults()">‚úÖ Finalise Results</button>
            </div>

            <div class="student-grid" id="adjudicationGrid"></div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <div class="winner-announcement">
                <h2>üéâ Winner!</h2>
                <div class="winner-name" id="winnerName">---</div>
                <p style="font-size: 1.5rem; color: var(--accent);">with <span id="winnerScore">0</span> points!</p>
            </div>

            <div class="scoreboard">
                <h2>üìä Final Scores</h2>
                <div class="scoreboard-list" id="finalScoreboard"></div>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="newRound()">üîÑ New Round</button>
                <button class="btn btn-secondary" onclick="resetGame()">üè† Back to Start</button>
            </div>
        </div>
    </div>

    <script>
        // API ENDPOINT - Connected to AWS REST API
        const API_ENDPOINT = 'https://64gv8dvarh.execute-api.ap-southeast-4.amazonaws.com/prod';
        
        // DEMO MODE - Automatically disabled when API is configured
        const DEMO_MODE = false;

        let gameCode = '';
        let currentLetter = '';
        let categories = [];
        let timerInterval = null;
        let timeRemaining = 300; // 5 minutes in seconds
        let submissions = {};
        let pollInterval = null;

        // Standard Scattergories categories
        const allCategories = [
            "A boy's name", "U.S. cities", "Things that are cold", "School subjects",
            "Vegetables", "Types of music", "Bodies of water", "Insects",
            "Breakfast foods", "Furniture", "TV shows", "Things in a park",
            "Foreign cities", "Stones/gems", "Musical instruments", "Authors",
            "Parts of the body", "Cooking utensils", "Monuments", "Buildings",
            "Famous athletes", "Fruits", "Things you wear", "Toys",
            "Countries", "Things in the sky", "Pizza toppings", "Colleges/universities",
            "Fish", "Countries", "Things in a souvenir shop", "Items in a vending machine",
            "Movie titles", "Games", "Things that you plug in", "Animals",
            "Languages", "Names used in the Bible", "Junk food", "Things that grow",
            "Companies", "Video games", "Electronic gadgets", "Cartoon characters",
            "Types of drinks", "Musical groups", "Store names", "Things in a grocery store",
            "Reasons to make a phone call", "Villains/monsters", "Flowers", "Things you shout",
            "Sports equipment", "Crimes", "Things that are sticky", "Awards/honours",
            "Cars", "Spices/herbs", "Bad habits", "Cosmetics/toiletries",
            "Celebrities", "Cooking terms", "Reptiles/amphibians", "Footwear",
            "Things in a medicine cabinet", "Toys and games", "Hobbies", "Current pop stars",
            "Websites", "Tools", "Items in a refrigerator", "Farm animals",
            "Street names", "Things at a carnival", "Nicknames", "Things in the ocean",
            "Foods you eat raw", "Things you get tickets for", "Words associated with money",
            "Items in a suitcase", "Types of weather", "Famous duos and trios"
        ];

        function toggleHelp() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanel.classList.toggle('active');
        }

        function generateGameCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function generateLetter() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            // Exclude difficult letters
            const excludeLetters = ['Q', 'U', 'X', 'Z'];
            const validLetters = letters.filter(l => !excludeLetters.includes(l));
            return validLetters[Math.floor(Math.random() * validLetters.length)];
        }

        function selectCategories() {
            const shuffled = [...allCategories].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, 12);
        }

        async function startNewGame() {
            gameCode = generateGameCode();
            currentLetter = generateLetter();
            categories = selectCategories();
            timeRemaining = 300;
            submissions = {};

            // Create game session via API (or demo mode)
            try {
                if (!DEMO_MODE) {
                    await fetch(`${API_ENDPOINT}/game`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            gameCode: gameCode,
                            letter: currentLetter,
                            categories: categories
                        })
                    });
                } else {
                    console.log('DEMO MODE: Game created locally');
                    // Store game in localStorage so student page can access it
                    localStorage.setItem('scattergories_demo_game', JSON.stringify({
                        gameCode: gameCode,
                        letter: currentLetter,
                        categories: categories
                    }));
                    console.log('DEMO MODE: Saved game data for students');
                    
                    // In demo mode, add some fake submissions after a delay
                    setTimeout(() => {
                        addDemoSubmissions();
                    }, 3000);
                }

                // Update UI
                document.getElementById('gameCodeDisplay').textContent = gameCode;
                document.getElementById('letterDisplay').textContent = currentLetter;
                
                const categoriesList = document.getElementById('categoriesList');
                categoriesList.innerHTML = '';
                categories.forEach((cat, idx) => {
                    const div = document.createElement('div');
                    div.className = 'category-item';
                    div.innerHTML = `<span class="category-number">${idx + 1}.</span>${cat}`;
                    categoriesList.appendChild(div);
                });

                // Show game screen
                document.getElementById('setupScreen').classList.remove('active');
                document.getElementById('gameScreen').classList.add('active');

                // Start polling for submissions
                if (!DEMO_MODE) {
                    startPolling();
                }
            } catch (error) {
                console.error('Error starting game:', error);
                if (!DEMO_MODE) {
                    alert('Error starting game. Please check your API configuration.');
                }
            }
        }

        // Demo mode helper - adds fake student submissions
        function addDemoSubmissions() {
            if (!DEMO_MODE) return;
            
            const demoStudents = ['Emma', 'Liam', 'Sophie', 'Jack'];
            const letter = currentLetter.toLowerCase();
            
            demoStudents.forEach((name, idx) => {
                setTimeout(() => {
                    const answers = categories.map((cat, catIdx) => {
                        // Generate somewhat realistic answers
                        if (Math.random() > 0.1) { // 90% chance of answering
                            if (catIdx === 0 && idx < 2) return letter.toUpperCase() + 'mma'; // Duplicate for testing
                            return letter.toUpperCase() + getRandomEnding(catIdx);
                        }
                        return ''; // Some blank answers
                    });
                    submissions[name] = answers;
                    updateSubmissionsList();
                }, idx * 2000); // Stagger submissions
            });
        }

        function getRandomEnding(seed) {
            const endings = ['avier', 'achel', 'ara', 'liver', 'wen', 'yla', 'ack', 'oey', 'ina', 'ax'];
            return endings[seed % endings.length];
        }

        function startTimer() {
            if (timerInterval) return;

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const timerEl = document.getElementById('timer');
            timerEl.textContent = display;

            if (timeRemaining <= 60) {
                timerEl.classList.add('warning');
            }
        }

        async function startPolling() {
            if (DEMO_MODE) {
                console.log('DEMO MODE: Polling disabled');
                return;
            }
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_ENDPOINT}/submissions?gameCode=${gameCode}`);
                    const data = await response.json();
                    
                    submissions = data.submissions || {};
                    updateSubmissionsList();
                } catch (error) {
                    console.error('Error polling submissions:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        function updateSubmissionsList() {
            const count = Object.keys(submissions).length;
            document.getElementById('submissionCount').textContent = count;

            const list = document.getElementById('submissionsList');
            list.innerHTML = '';

            Object.entries(submissions).forEach(([studentName, answers]) => {
                const div = document.createElement('div');
                div.className = 'submission-item';
                div.innerHTML = `
                    <span>‚úÖ ${studentName}</span>
                    <span style="color: var(--success); font-weight: 600;">Submitted</span>
                `;
                list.appendChild(div);
            });
        }

        function endGame() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }

            // Move to adjudication screen
            analyseAnswers();
            showAdjudicationScreen();
        }

        function analyseAnswers() {
            // Group answers by category
            const answersByCategory = {};
            
            Object.entries(submissions).forEach(([studentName, answers]) => {
                answers.forEach((answer, idx) => {
                    if (!answersByCategory[idx]) {
                        answersByCategory[idx] = [];
                    }
                    answersByCategory[idx].push({
                        student: studentName,
                        answer: answer.trim().toLowerCase()
                    });
                });
            });

            // Analyse uniqueness
            Object.entries(submissions).forEach(([studentName, answers]) => {
                submissions[studentName] = answers.map((answer, idx) => {
                    const normalised = answer.trim().toLowerCase();
                    const categoryAnswers = answersByCategory[idx] || [];
                    const matches = categoryAnswers.filter(a => a.answer === normalised);
                    
                    let status = 'unique';
                    if (matches.length > 1) {
                        status = 'duplicate';
                    } else if (!answer.trim() || !answer.toLowerCase().startsWith(currentLetter.toLowerCase())) {
                        status = 'needs-review';
                    }

                    return {
                        text: answer,
                        status: status,
                        approved: status === 'unique'
                    };
                });
            });
        }

        function showAdjudicationScreen() {
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('adjudicationScreen').classList.add('active');

            const grid = document.getElementById('adjudicationGrid');
            grid.innerHTML = '';

            Object.entries(submissions).forEach(([studentName, answers]) => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const score = answers.filter(a => a.approved).length;

                let answersHtml = '';
                answers.forEach((answer, idx) => {
                    const statusText = answer.status === 'unique' ? 'Unique ‚úì' :
                                     answer.status === 'duplicate' ? 'Duplicate' :
                                     'Review Needed';

                    answersHtml += `
                        <div class="answer-row ${answer.status}">
                            <div class="answer-category">${idx + 1}</div>
                            <div class="answer-text">${answer.text || '(no answer)'}</div>
                            ${answer.status === 'needs-review' ? `
                                <div class="adjudication-controls">
                                    <button class="btn-approve" onclick="approveAnswer('${studentName}', ${idx})">‚úì</button>
                                    <button class="btn-reject" onclick="rejectAnswer('${studentName}', ${idx})">‚úó</button>
                                </div>
                            ` : `<div class="answer-status">${statusText}</div>`}
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="student-header">
                        <div class="student-name">${studentName}</div>
                        <div class="student-score" id="score-${studentName}">${score}/12</div>
                    </div>
                    ${answersHtml}
                `;

                grid.appendChild(card);
            });

            updateCurrentScoreboard();
        }

        function approveAnswer(studentName, answerIdx) {
            submissions[studentName][answerIdx].approved = true;
            submissions[studentName][answerIdx].status = 'unique';
            showAdjudicationScreen();
        }

        function rejectAnswer(studentName, answerIdx) {
            submissions[studentName][answerIdx].approved = false;
            submissions[studentName][answerIdx].status = 'duplicate';
            showAdjudicationScreen();
        }

        function updateCurrentScoreboard() {
            const scores = Object.entries(submissions).map(([name, answers]) => ({
                name: name,
                score: answers.filter(a => a.approved).length
            })).sort((a, b) => b.score - a.score);

            const scoreboard = document.getElementById('currentScoreboard');
            scoreboard.innerHTML = '';

            scores.forEach((entry, idx) => {
                const div = document.createElement('div');
                div.className = 'score-item';
                div.innerHTML = `
                    <div class="score-rank">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`}</div>
                    <div class="score-name">${entry.name}</div>
                    <div class="score-points">${entry.score}</div>
                `;
                scoreboard.appendChild(div);
            });
        }

        function finaliseResults() {
            const scores = Object.entries(submissions).map(([name, answers]) => ({
                name: name,
                score: answers.filter(a => a.approved).length
            })).sort((a, b) => b.score - a.score);

            if (scores.length > 0) {
                const winner = scores[0];
                document.getElementById('winnerName').textContent = winner.name;
                document.getElementById('winnerScore').textContent = winner.score;

                const finalScoreboard = document.getElementById('finalScoreboard');
                finalScoreboard.innerHTML = '';

                scores.forEach((entry, idx) => {
                    const div = document.createElement('div');
                    div.className = 'score-item';
                    div.innerHTML = `
                        <div class="score-rank">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `#${idx + 1}`}</div>
                        <div class="score-name">${entry.name}</div>
                        <div class="score-points">${entry.score}</div>
                    `;
                    finalScoreboard.appendChild(div);
                });
            }

            document.getElementById('adjudicationScreen').classList.remove('active');
            document.getElementById('resultsScreen').classList.add('active');
        }

        function newRound() {
            startNewGame();
            document.getElementById('resultsScreen').classList.remove('active');
        }

        function resetGame() {
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('setupScreen').classList.add('active');
        }

        // Show demo mode banner if in demo mode
        if (DEMO_MODE) {
            document.getElementById('demoModeBanner').style.display = 'block';
            console.log('%cüéÆ DEMO MODE ACTIVE', 'color: #FDC500; font-size: 16px; font-weight: bold;');
            console.log('This version works without AWS backend - perfect for testing!');
            console.log('To use with real students, follow AWS-SETUP-GUIDE.md');
        }
    </script>
</body>
</html>
